## ä¸€ã€å¤–é”®çº¦æŸ

### 1ã€åˆ›å»ºå¤–é”®

**å¤–é”®**ï¼šforeign keyï¼Œè¡¨ä¸­æŒ‡**å‘å¤–éƒ¨è¡¨ä¸»é”®**çš„å­—æ®µå®šä¹‰æˆå¤–é”®

* å¤–é”®å¿…é¡»è¦é€šè¿‡è¯­æ³•æŒ‡å®šæ‰èƒ½ç§°ä¹‹ä¸ºå¤–é”®
  * ==[constraint`å¤–é”®å`] foreign key(å½“å‰è¡¨å­—æ®µå) references å¤–éƒ¨è¡¨(ä¸»é”®å­—æ®µ)==
* å¤–é”®æ„æˆæ¡ä»¶âœ¨
  * å¤–é”®å­—æ®µå¿…é¡»ä¸å¯¹åº”è¡¨çš„ä¸»é”®å­—æ®µç±»å‹ã€é•¿åº¦ã€å­—ç¬¦é›†ã€å¼•æ“ä¸€è‡´
  * å¤–é”®å­—æ®µæœ¬èº«è¦æ±‚æ˜¯ä¸€ä¸ªç´¢å¼•ï¼ˆåˆ›å»ºå¤–é”®ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªç´¢å¼•ï¼‰

```mysql
#åˆ›å»ºä¸“ä¸šè¡¨å’Œå­¦ç”Ÿè¡¨ï¼Œå­¦ç”Ÿè¡¨ä¸­çš„ä¸“ä¸šidæŒ‡å‘ä¸“ä¸šè¡¨id
create table t_1(
	id int primary key auto_increment,
    name varchar(50) not null unique
)charset utf8;

create table t_49(
	id int primary key auto_increment,
    name varchar(50) not null,
    c_id int,
    foreign key(c_id) references t_47(id)
    /*
    	å¤–é”®å¯ä»¥ä¸æŒ‡å®šåå­—ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆ
    constraint `c_id` foreign key(c_id) references t_47(id)
    */
)charset utf8;

#æŸ¥çœ‹å¤–é”®åå­—constraintã€å¤–é”®ç´¢å¼•åkey
show create table t_2;
```

### 2ã€å¤–é”®çº¦æŸ

**å¤–é”®çº¦æŸæ§åˆ¶**ï¼šå¤–é”®å¯ä»¥åœ¨å®šä¹‰æ—¶æ§åˆ¶å¤–é”®çš„çº¦æŸä½œç”¨

* æ§åˆ¶ç±»å‹
  * on updateï¼šçˆ¶è¡¨æ›´æ–°æ—¶å­è¡¨çš„è¡¨ç°
  * on deleteï¼šçˆ¶è¡¨åˆ é™¤æ—¶å­è¡¨çš„è¡¨ç°
* æ§åˆ¶æ–¹å¼
  * cascadeï¼šçº§è”æ“ä½œï¼Œçˆ¶è¡¨æ“ä½œåå­è¡¨è·Ÿéšæ“ä½œ
  * set nullï¼šç½®ç©ºæ“ä½œï¼Œçˆ¶è¡¨æ“ä½œåï¼Œå­è¡¨å…³è”çš„å¤–é”®å­—æ®µç½®ç©º
  * restrictï¼šä¸¥æ ¼æ¨¡å¼ï¼Œä¸å…è®¸çˆ¶è¡¨æ“ä½œï¼ˆé»˜è®¤çš„ï¼‰
  * no actionï¼šå­è¡¨ä¸ç®¡

â‘ æ³¨æ„äº‹é¡¹ï¼š

```mysql
-- 1ã€å­è¡¨ä¸èƒ½æ’å…¥ä¸»è¡¨ä¸å­˜åœ¨çš„æ•°æ®

-- 2ã€é»˜è®¤çš„å¤–é”®äº§ç”Ÿåï¼Œä¸»é”®ä¸èƒ½æ›´æ–°è¢«å…³è”çš„ä¸»é”®å­—æ®µæˆ–è€…åˆ é™¤è¢«å…³è”çš„ä¸»é”®è®°å½•

-- 3ã€å­è¡¨å¯ä»¥æ’å…¥å¤–é”®ä¸ºNullçš„æ•°æ®
```

â‘¡å¤–é”®çº¦æŸï¼š

é™åˆ¶å¤–é”®çº¦æŸï¼Œä¸€èˆ¬ä½¿ç”¨æ›´æ–°çº§è”ï¼Œåˆ é™¤ç½®ç©º

* on update cascadeï¼šæ›´æ–°çº§è”
* on delete set nullï¼šåˆ é™¤ç½®ç©º

```mysql
create table t_50(
	id int primary key auto_increment,
    name varchar(50) not null unique
)charset utf8;

create table t_51(
	id int primary key auto_increment,
    name varchar(50) not null,
    c_id int, # å¦‚æœè¦å…è®¸ç½®ç©ºï¼Œå°±ä¸èƒ½not null
    foreign key(c_id) references t_50(id) on update cascade on delete set null
)charset utf8;

insert into t_50 values(null,'Chinese'),(null,'Computer');
insert into t_51 values(null,'Tony',1),(null,'Petter',2);
```

### 3ã€å¤–é”®ç®¡ç†

```mysql
#æ–°å¢å¤–é”®
-- alter table è¡¨å add [constraint `å¤–å»ºå`] foreign key(å¤–é”®å­—æ®µ) references è¡¨å(ä¸»é”®) [on å¤–é”®çº¦æŸ]
alter table t_51 add constraint `t_51_50` foreign key(c_id) references t_50(id);

#åˆ é™¤å¤–é”®
-- alter table è¡¨å drop foreign key å¤–é”®å;
alter table t_51 drop foreign key t_51_ibfk_1;	# ç³»ç»Ÿç”Ÿæˆçš„å¤–é”®
```



## äºŒã€äº‹åŠ¡å®‰å…¨

#### åº”ç”¨åœºæ™¯ï¼šè½¬è´¦

â‘ MySQLä¸­é»˜è®¤çš„å†™æ“ä½œæ˜¯ç›´æ¥å†™å…¥çš„

* æ‰§è¡Œå†™æ“ä½œSQL
* **åŒæ­¥åˆ°æ•°æ®è¡¨**

ï¼ˆå¯ä»¥å‘ç°ï¼Œå¯¹åº”è½¬è´¦çš„å®é™…åº”ç”¨åœºæ™¯ï¼Œå®ƒå¹¶ä¸å®‰å…¨ï¼‰

â‘¡ä½¿ç”¨äº‹åŠ¡

åœ¨æ“ä½œå‰å‘ŠçŸ¥ç³»ç»Ÿï¼Œæ¥ä¸‹æ¥æ‰€æœ‰çš„æ“ä½œéƒ½æš‚**ä¸åŒæ­¥åˆ°æ•°æ®è¡¨**ï¼Œè€Œæ˜¯è®°å½•åˆ°**äº‹åŠ¡æ—¥å¿—**ï¼ŒæŒ‡å¯¼åç»­æ‰€æœ‰æ“ä½œéƒ½æˆåŠŸï¼Œå†è¿›è¡ŒåŒæ­¥ï¼›å¦åˆ™å–æ¶ˆæ‰€æœ‰æ“ä½œ

### 1ã€äº‹åŠ¡å¤„ç†

**äº‹åŠ¡å¤„ç†**ï¼šåˆ©ç”¨è‡ªåŠ¨æˆ–è€…æ‰‹åŠ¨æ–¹å¼å®ç°äº‹åŠ¡ç®¡ç†

* è‡ªåŠ¨äº‹åŠ¡å¤„ç†ï¼šç³»ç»Ÿé»˜è®¤ï¼Œæ“ä½œç»“æŸç›´æ¥åŒæ­¥åˆ°æ•°æ®è¡¨ï¼ˆäº‹åŠ¡å…³é—­çŠ¶æ€ï¼‰
  * ç³»ç»Ÿæ§åˆ¶ï¼šå˜é‡ autocommitï¼ˆå€¼ä¸ºONï¼Œè‡ªåŠ¨æäº¤ï¼‰
* ==æ‰‹åŠ¨äº‹åŠ¡å¤„ç†==
  * å¼€å¯äº‹åŠ¡ï¼š `start transaction`
  * å…³é—­äº‹åŠ¡
    * æäº¤äº‹åŠ¡ï¼š`commit`ï¼ˆåŒæ­¥åˆ°æ•°æ®è¡¨åŒæ—¶æ¸…ç©ºæ—¥å¿—æ•°æ®ï¼‰
    * å›æ»šäº‹åŠ¡ï¼š`rollback`ï¼ˆæ¸…ç©ºæ—¥å¿—æ•°æ®ï¼‰
* äº‹åŠ¡å›æ»šï¼šåœ¨é•¿äº‹åŠ¡æ‰§è¡Œä¸­ï¼Œå¯ä»¥åœ¨æŸä¸ªå·²ç»æˆåŠŸçš„èŠ‚ç‚¹å¤„è®¾ç½®å›æ»šç‚¹ï¼Œåç»­å›æ»šçš„è¯å¯ä»¥å›åˆ°æŸä¸ªæˆåŠŸç‚¹
  * è®¾ç½®å›æ»šç‚¹ï¼š`savepoint å›æ»šç‚¹åå­—`
  * å›æ»šåˆ°å›æ»šç‚¹ï¼š`rollback to å›æ»šç‚¹åå­—`

#### â‘ æ‰‹åŠ¨äº‹åŠ¡å¤„ç†

```mysql
# æ‰‹åŠ¨äº‹åŠ¡ï¼šå¯ç”¨äº‹åŠ¡è½¬è´¦ï¼ŒæˆåŠŸæäº¤äº‹åŠ¡
-- å¼€å¯äº‹åŠ¡
start transaction;

-- Tomæ‰£é’±
update t_52 set account = account - 1000 where id  = 1;

-- Lucyæ”¶é’±
update t_52 set account = account + 1000 where id  = 2;

-- æäº¤äº‹åŠ¡
commit;
```

#### â‘¡äº‹åŠ¡å›æ»š

å¦‚æœå› å·¥ä½œäººå‘˜æ“ä½œå¤±è¯¯ï¼ŒLucyçš„é’±åŠ å¤šäº†ï¼Ÿ

```mysql
# å¼€å¯äº‹åŠ¡
start transaction;

# Tomæ‰£é’±
update t_52 set account = account - 1000 where id= 1;

# è®¾ç½®å›æ»šç‚¹
savepoint sp1;

# Lucyæ”¶é’±
update t_52 set account = account + 10000 where id= 2;

# æ“ä½œå¤±è´¥å›åˆ°å›æ»šç‚¹
rollback to sp1;

# Lucyæ”¶é’±
update t_52 set account = account + 1000 where id= 2;

# æäº¤äº‹åŠ¡
commit;
```

#### â‘¢è®¾ç½®é»˜è®¤äº‹åŠ¡æ¨¡å¼

```mysql
show variables like 'autocommit';

set autocommit = 0;	
```

### 2ã€äº‹åŠ¡çš„ç‰¹ç‚¹

**äº‹åŠ¡ç‰¹ç‚¹**ï¼šäº‹åŠ¡å¤„ç†å…·æœ‰ACIDå››å¤§ç‰¹æ€§

* åŸå­æ€§ï¼ˆAtomicity ï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡æ“ä½œæ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œä¸å¯æ‹†åˆ†ï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
* ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡æ‰§è¡Œä¹‹å‰å’Œæ‰§è¡Œä¹‹åéƒ½å¿…é¡»å¤„äºä¸€è‡´æ€§çŠ¶æ€ï¼Œæ•°æ®çš„å®Œæ•´æ€§æ²¡æœ‰è¢«ç ´åï¼ˆäº‹åŠ¡é€»è¾‘çš„å‡†ç¡®æ€§ï¼‰
* éš”ç¦»æ€§ï¼ˆIsolation ï¼‰ï¼šäº‹åŠ¡æ“ä½œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äº‹åŠ¡ä¸å¯è§
* æŒä¹…æ€§ï¼ˆDurability ï¼‰ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œç»“æœä¸å¯æ”¹å˜

### 3ã€äº‹åŠ¡é”ã€è„è¯»

* **äº‹åŠ¡é”**ï¼šå½“ä¸€ä¸ªäº‹åŠ¡å¼€å¯æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡æ˜¯ä¸èƒ½å¯¹å½“å‰äº‹åŠ¡é”å ç”¨çš„æ•°æ®è¿›è¡Œæ“ä½œçš„
  * è¡Œé”ï¼šå½“å‰äº‹åŠ¡åªå ç”¨äº†ä¸€è¡Œï¼ˆidç²¾ç¡®æ£€ç´¢æ•°æ®ï¼‰ï¼Œé‚£ä¹ˆå…¶ä»–äº‹åŠ¡å¯ä»¥æ“ä½œå…¶ä»–è¡Œæ•°æ®
  * è¡¨é”ï¼šå½“å‰äº‹åŠ¡å ç”¨äº†æ•´å¼ è¡¨ï¼ˆlikeæ‰«ç æ•´ä¸ªè¡¨ï¼‰ï¼Œé‚£ä¹ˆå…¶ä»–äº‹åŠ¡å¯¹æ•´å¼ è¡¨éƒ½ä¸èƒ½æ“ä½œ
* **è„è¯»**ï¼šä¸€ä¸ªäº‹åŠ¡åœ¨å¯¹æŸä¸ªæ•°æ®è¿›è¡Œæ“ä½œä½†å°šæœªæäº¤ï¼Œè€Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°äº†è¿™ä¸ªâ€œå†å²â€æ•°æ®å…¶å®å·²ç»è¢«ä¿®æ”¹

#### é‡ç‚¹ï¼š

æ‰©å±•ï¼šäº‹åŠ¡å¤„ç†çš„æ”¯æŒæ˜¯æœ‰æ¡ä»¶çš„

* å­˜å‚¨å¼•æ“éœ€è¦ä¸º==InnoDB==

## ä¸‰ã€é¢„å¤„ç†

è¦æ‰§è¡Œçš„SQLæŒ‡ä»¤æƒ³ä½¿ç”¨é¢„å¤„ç†

* <span style="color:red">å‡å°‘é‡å¤æ‰§è¡Œ</span>çš„æŒ‡ä»¤
* æ¶‰åŠæ•°æ®å®‰å…¨çš„æŒ‡ä»¤ï¼ˆ<span style="color:red">é˜²æ­¢SQLæ³¨å…¥</span>çš„å®‰å…¨é—®é¢˜ï¼‰

### 1ã€é¢„å¤„ç†

```mysql
#æŸ¥è¯¢å­¦ç”Ÿçš„SQLæŒ‡ä»¤éœ€è¦é‡å¤æ‰§è¡Œå¾ˆå¤šæ¬¡

-- ä¼ ç»Ÿçš„æŸ¥è¯¢æ“ä½œ
select * from t_42;
select * from t_42;
select * from t_42;


-- ä½¿ç”¨é¢„å¤„ç†æ“ä½œ
# é¢„å¤„ç†æ“ä½œï¼šå‘é€é¢„å¤„ç†
prepare p1 from 'select * from t_42';

# é¢„å¤„ç†æ“ä½œï¼šæ‰§è¡Œé¢„å¤„ç†
execute p1;
execute p1;
execute p1;

# åˆ é™¤é¢„å¤„ç†
deallocate  prepare p1;
```

### 2ã€é¢„å¤„ç†ä¼ å‚ğŸ’–

**é¢„å¤„ç†ä¼ å‚**ï¼šåœ¨æ‰§è¡Œé¢„å¤„ç†çš„æ—¶å€™ä¼ å…¥é¢„å¤„ç†éœ€è¦çš„==å¯å˜æ•°æ®==

```mysql
# å‡†å¤‡é¢„å¤„ç†ï¼šæ¶‰åŠå‚æ•°
prepare t_40_insert from 'insert into t_40 values(null,?,?,?,?)';

# è®¾ç½®å˜é‡å¹¶ä¼ å…¥å‚æ•°
set @name = 'è¯å¸ˆå…œ';
set @gender = 'ç”·';
set @age = 23;
set @class_name = 'æœ¨å¶1ç­';

# æ‰§è¡Œé¢„å¤„ç†
execute t_40_insert using @name,@gender,@age,@class_name;

# åˆ é™¤é¢„å¤„ç†
deallocate  prepare t_40_insert;
```



## å››ã€è§†å›¾

**è§†å›¾**ï¼šviewï¼Œä¸€ç§ç”±selectæŒ‡ä»¤ç»„æˆçš„**è™šæ‹Ÿè¡¨**

* è§†å›¾æ˜¯è™šæ‹Ÿè¡¨ï¼Œå¯ä»¥ä½¿ç”¨è¡¨ç®¡ç†ï¼ˆç»“æ„ç®¡ç†ï¼‰
  * ä¸ºè§†å›¾æä¾›æ•°æ®çš„è¡¨å«åšåŸºè¡¨
* ==è§†å›¾æœ‰ç»“æ„ï¼Œä½†ä¸å­˜å‚¨æ•°æ®==âœ¨
  * ç»“æ„ï¼šåˆ›é€ è§†å›¾æ—¶ï¼Œselecté€‰æ‹©çš„å­—æ®µ
  * æ•°æ®ï¼šæ¥æºäºè®¿é—®è§†å›¾æ—¶æ‰§è¡Œçš„selectæŒ‡ä»¤

### 1ã€è§†å›¾çš„åˆ›å»ºä¸ä½¿ç”¨

```mysql
# åˆ›å»ºè§†å›¾
create view è§†å›¾åå­— as selectæŒ‡ä»¤;

# è®¿é—®è§†å›¾ï¼šä¸€èˆ¬éƒ½æ˜¯æŸ¥è¯¢
select */å­—æ®µå from è§†å›¾åå­—;
```

```mysql
#æœ‰äº›å¤æ‚çš„SQLåˆæ˜¯ç»å¸¸ç”¨åˆ°çš„ï¼Œå¦‚å¤šå¼ è¡¨çš„è¿è¡¨æ“ä½œï¼šå¯ä»¥åˆ©ç”¨è§†å›¾å®ç°
-- é™¢ç³»è¡¨
create table t_53(
	id int primary key auto_increment,
    name varchar(50) not null
)charset utf8;
insert into t_53 values(null,'è¯­è¨€ç³»'),(null,'è€ƒå¤ç³»');

-- ä¸“ä¸šè¡¨
create table t_54(
    id int primary key auto_increment,
    name varchar(50) not null,
    s_id int not null comment 'å­¦é™¢id'
)charset utf8;
insert into t_54 values(null,'English',1),(null,'Chinese',1);

-- å­¦ç”Ÿè¡¨
create table t_55(
	id int primary key auto_increment,
    name varchar(50) not null,
    s_id int not null comment 'ä¸“ä¸šId'
)charset utf8;
insert into t_55 values(null,'Lilei',2),(null,'Mark',2),(null,'Tony',1);

#è·å–æ‰€æœ‰å­¦ç”Ÿçš„æ˜ç»†ä¿¡æ¯
-- æ–¹å¼ä¸€ï¼šä¼ ç»Ÿæ–¹æ³•
select stu.*,sub.name as sub_name,sub.s_id as sch_id,sch.name as sch_name 
from t_55 as stu left join t_54 sub on stu.s_id = sub.id left join t_53 sch on sub.s_id = sch.id;

-- æ–¹å¼äºŒï¼šä»¥è§†å›¾ä¿å­˜è¿™ç±»å¤æ‚æŒ‡ä»¤ï¼Œåç»­å¯ä»¥ç›´æ¥è®¿é—®è§†å›¾
create view v_student_detail 
as 
select stu.*,sub.name as sub_name,sub.s_id as sch_id,sch.name as sch_name from t_55 as stu left join t_54 sub on stu.s_id = sub.id left join t_53 sch on sub.s_id = sch.id;

select * from v_student_detail;
```

### 2ã€è§†å›¾ç®¡ç†

```mysql
#1ã€æŸ¥çœ‹è§†å›¾
show tables;	# æŸ¥çœ‹å…¨éƒ¨è§†å›¾
show create table/view è§†å›¾åå­—;	# æŸ¥çœ‹è§†å›¾åˆ›å»ºæŒ‡ä»¤
desc è§†å›¾åå­—;	 # æŸ¥çœ‹è§†å›¾ç»“æ„

#2ã€æ›´æ”¹è§†å›¾
alter view è§†å›¾å as æ–°çš„æŸ¥è¯¢æŒ‡ä»¤;
create or replace view è§†å›¾å as æ–°çš„æŸ¥è¯¢æŒ‡ä»¤;	# åˆ›å»ºæ–°çš„æˆ–è€…æ›¿æ¢æ–°çš„

#3ã€åˆ é™¤è§†å›¾
drop view è§†å›¾å; 
```

### 3ã€è§†å›¾çš„æ•°æ®æ“ä½œ

â‘ æ•°æ®æ“ä½œæœ‰æ¡ä»¶

è§†å›¾æ“ä½œæ¡ä»¶

* å¤šåŸºè¡¨è§†å›¾ï¼šä¸å…è®¸æ“ä½œï¼ˆå¢åˆ æ”¹éƒ½ä¸è¡Œï¼‰
* å•åŸºè¡¨è§†å›¾ï¼šå…è®¸å¢åˆ æ”¹
  * æ–°å¢æ¡ä»¶ï¼šè§†å›¾çš„å­—æ®µå¿…é¡»åŒ…å«åŸºè¡¨ä¸­æ‰€æœ‰ä¸å…è®¸ä¸ºç©ºçš„å­—æ®µ
* with check optionï¼šæ“ä½œæ£€æŸ¥è§„åˆ™
  * é»˜è®¤ä¸éœ€è¦è¿™ä¸ªè§„åˆ™ï¼ˆåˆ›å»ºè§†å›¾æ—¶æŒ‡å®šï¼‰ï¼šè§†å›¾æ“ä½œåªè¦æ»¡è¶³å‰é¢ä¸Šè¿°æ¡ä»¶å³å¯
  * å¢åŠ æ­¤è§„åˆ™ï¼šè§†å›¾çš„æ•°æ®æ“ä½œåï¼Œå¿…é¡»è¦ä¿è¯è¯¥è§†å›¾è¿˜èƒ½æŠŠé€šè¿‡è§†å›¾æ“ä½œçš„æ•°æ®æŸ¥å‡ºæ¥ï¼ˆå¦åˆ™å¤±è´¥ï¼‰

â‘¡æ•°æ®æ“ä½œçš„è¯­å¥

åŒæ™®é€šçš„è¡¨æ“ä½œä¸€æ ·

â‘¢è§†å›¾æ•°æ®æ“ä½œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸å…è®¸çš„ï¼Œé€šå¸¸ä¹‹æ‰€ä»¥å¯¹å¤–æä¾›è§†å›¾å°±æä¾›æ•°æ®çš„åªè¯»æ“ä½œ

### 4ã€è§†å›¾ç®—æ³•

è§†å›¾ç®—æ³•ä¸€å…±æœ‰ä¸‰ç§

* undefinedï¼šé»˜è®¤çš„ï¼Œæœªå®šä¹‰ç®—æ³•ï¼Œå³ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©ç®—æ³•
* ==merge==ï¼šåˆå¹¶ç®—æ³•ï¼Œå°±æ˜¯å°†è§†å›¾å¤–éƒ¨æŸ¥è¯¢è¯­å¥è·Ÿè§†å›¾å†…éƒ¨selectè¯­å¥åˆå¹¶åæ‰§è¡Œï¼Œ<span style="color:red">æ•ˆç‡é«˜</span>ï¼ˆç³»ç»Ÿä¼˜å…ˆé€‰æ‹©ï¼‰
* ==temptable==ï¼šä¸´æ—¶è¡¨ç®—æ³•ï¼Œå³ç³»ç»Ÿå°†è§†å›¾çš„selectè¯­å¥æŸ¥å‡ºæ¥å…ˆâœ¨å¾—å‡ºä¸€å¼ ä¸´æ—¶è¡¨ï¼Œç„¶åå¤–éƒ¨å†æŸ¥è¯¢ï¼Œ<span style="color:red">å®‰å…¨</span>ï¼ˆtemptableç®—æ³•è§†å›¾ä¸å…è®¸å†™æ“ä½œï¼‰

```mysql
# é»˜è®¤ç®—æ³•ï¼šalgorithm = undefined
create algorithm = undefined view v_student_4 as select * from t_42 order by age desc;

# åˆå¹¶ç®—æ³•ï¼šalgorithm = merg
create algorithm = merge view v_student_5 as select * from t_42 order by age desc;

# ä¸´æ—¶è¡¨æ˜¯å¦ï¼šalgorithm = temptable
create algorithm = temptable view v_student_6 as select * from t_42 order by age desc;
```

ä¸€èˆ¬åœ¨è®¾è®¡è§†å›¾çš„æ—¶å€™è¦è€ƒè™‘åˆ°è§†å›¾ç®—æ³•çš„å¯è¡Œæ€§ï¼Œé€šå¸¸è§†å›¾ä¸­å¦‚æœå‡ºç°äº†order byæ’åºçš„è¯ï¼Œå°±è¦è€ƒè™‘ä½¿ç”¨temptableç®—æ³•

* åªè¦mergeä»¥åï¼Œä¸ä¼šå¯¼è‡´æ•°æ®å› ä¸ºå­å¥çš„å…ˆåé¡ºåºè€Œæ··ä¹±ï¼ˆorder byä¸group byçš„é¡ºåºæ··ä¹±å®¹æ˜“å‡ºé—®é¢˜ï¼‰



## äº”ã€æ•°æ®å¤‡ä»½ä¸è¿˜åŸ*

**å¤‡ä»½**ï¼šbackupï¼Œå°†æ•°æ®æˆ–è€…ç»“æ„æŒ‰ç…§ä¸€å®šçš„æ ¼å¼å­˜å‚¨åˆ°å¦å¤–ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä»¥ä¿éšœé˜¶æ®µæ•°æ®çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§

* å°†å½“å‰æ­£ç¡®æ•°æ®è¿›è¡Œæ•°æ®ä¿å­˜
* å¤‡ä»½é€šå¸¸æ˜¯æœ‰å›ºå®šçš„æ—¶é—´èŠ‚ç‚¹

**è¿˜åŸ**ï¼šrestoreï¼Œåœ¨å½“å‰æ•°æ®å‡ºé—®é¢˜çš„æƒ…å†µä¸‹ï¼Œå°†ä¹‹å‰å¤‡ä»½çš„æ•°æ®æ›¿æ¢æ‰å½“å‰æ•°æ®ï¼Œä¿è¯ç³»ç»Ÿçš„æŒç»­ã€æ­£ç¡®çš„è¿è¡Œ

* åŸºäºå¤‡ä»½è¿›è¡Œæ•°æ®è¿˜åŸ
* å¤‡ä»½è¿˜åŸä¸ä¸€å®šèƒ½å¤Ÿä¿è¯æ‰€æœ‰æŸå¤±æŒ½å›

### 1ã€è¡¨æ•°æ®

#### å¤‡ä»½

* å­—æ®µæ ¼å¼åŒ–ï¼šfields
  * terminated byï¼šå­—æ®µæ•°æ®ç»“æŸâœ¨åä½¿ç”¨çš„ç¬¦å·ï¼Œé»˜è®¤æ˜¯ç©ºæ ¼
  * enclosed byï¼šå­—æ®µæ•°æ®åŒ…è£¹ï¼Œé»˜è®¤ä»€ä¹ˆéƒ½æ²¡æœ‰
  * escaped byï¼šç‰¹æ®Šå­—ç¬¦çš„å¤„ç†ï¼Œé»˜è®¤æ˜¯è½¬ä¹‰
* è¡Œæ ¼å¼åŒ–ï¼šlines
  * terminated byï¼šè¡Œç»“æŸç¬¦å·ï¼Œé»˜è®¤æ˜¯\nï¼Œè‡ªåŠ¨æ¢è¡Œ
  * starting byï¼šè¡Œå¼€å§‹âœ¨ç¬¦å·ï¼Œé»˜è®¤æ²¡æœ‰

```mysql
/*
	select å­—æ®µåˆ—è¡¨|*  into outfile å¤–éƒ¨æ–‡ä»¶è·¯å¾„ 
		[fields terminated by æ ¼å¼ enclosed by æ ¼å¼]
		[lines terminated by æ ¼å¼ starting by æ ¼å¼]
	from æ•°æ®è¡¨;
*/

-- é»˜è®¤æ–¹å¼
select * into outfile  'D:/t_40.csv' from t_40;

-- è‡ªå®šä¹‰:
select name,gender,age,class_name into outfile 'D:/t_40_self.csv'
	fields terminated by '-' enclosed by '"'
	lines starting by 'GO:'
from t_40;

/*
æŠ¥é”™ä¸æƒé™secure-file-privé—®é¢˜ï¼š
	åœ¨ï¼ˆmy.iniï¼‰ä¸­é…ç½®å¥½è¿™ä¸ªé…ç½®é¡¹ï¼šsecure-file-priv = æ•°æ®å¯¼å…¥å¯¼å‡ºè·¯å¾„/ä¸æŒ‡å®šå€¼
	ï¼ˆé‡å¯MySQLç”Ÿæ•ˆï¼‰
*/
```

<img src="MySQLæ•°æ®åº“å®‰å…¨ç®¡ç†/image-20211107175102820.png" alt="image-20211107175102820" style="zoom:80%;" />

#### è¿˜åŸ

```mysql
/*
	load data infile 'æ•°æ®æ–‡ä»¶æ‰€åœ¨è·¯å¾„' into table è¡¨å
		[fields terminated by æ ¼å¼ enclosed by æ ¼å¼]
		[lines terminated by æ ¼å¼ starting by æ ¼å¼]
		[(å­—æ®µåˆ—è¡¨)];	# å¦‚æœæ˜¯éƒ¨åˆ†è¡¨å­—æ®µï¼Œé‚£ä¹ˆå¿…é¡»å°†å­—æ®µåˆ—è¡¨æ”¾åˆ°æœ€å
*/

#å°†t_40.csvæ•°æ®å¯¼å…¥åˆ°db_3æ•°æ®åº“ä¸­çš„ä¸€ä¸ªä¸t_40è¡¨ç»“æ„ä¸€è‡´çš„è¡¨ä¸­
create table t_40 like db_2.t_40;

-- é»˜è®¤ï¼š
load data infile 'D:/t_40.csv' into table t_40; # æœ‰å¯èƒ½å› ä¸ºå­—ç¬¦é›†å‡ºç°é—®é¢˜           
load data infile 'D:/t_40.csv' into table t_40 charset utf8; 

-- è‡ªå®šä¹‰ï¼š
load data infile 'D:/t_40_self.csv' into table t_40 charset utf8 
	fields terminated by '-' enclosed by '"' 
	lines starting by 'GO:' (name,gender,age,class_name) ;
```

### 2ã€æ–‡ä»¶*

ä¸æ¨è

â‘ MyIsamè¡¨çš„æ–‡ä»¶å¤‡ä»½ï¼šæ‰¾åˆ°ä¸‰ä¸ªæ–‡ä»¶ï¼Œå¤åˆ¶è¿ç§»

* sdiï¼šè¡¨ç»“æ„æ–‡ä»¶
* MYIï¼šç´¢å¼•æ–‡ä»¶
* MYDï¼šæ•°æ®æ–‡ä»¶

â‘¡InnoDBè¡¨çš„æ–‡ä»¶å¤‡ä»½ï¼šæ‰¾åˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¤åˆ¶è¿ç§»

* ibdï¼šè¡¨ç»“æ„æ–‡ä»¶
* ibdataï¼šæ‰€æœ‰InnoDBæ•°æ®æ–‡ä»¶

### 3ã€SQLğŸ’–

#### å¤‡ä»½

**åˆ©ç”¨binæ–‡ä»¶çš„Mysqldump.exeå®¢æˆ·ç«¯å®ç°å¤‡ä»½**

1ã€å…¨åº“å¤‡ä»½ï¼ˆå€ŸåŠ©äºWindowsä¸‹çš„cmdè®¿é—®mysqldump.exeï¼Œå½“å‰ç”¨æˆ·ä½¿ç”¨rootè´¦å·ï¼‰

`mysqldump.exe -uroot -proot --all-databases > D:/mysql.sql`



2ã€å•åº“å¤‡ä»½

`mysqldump -uroot -proot --databases db_2 > D:/db_2.sql`



3ã€å•è¡¨å¤‡ä»½ï¼ˆæ²¡æœ‰åˆ›å»ºæ•°æ®åº“çš„æŒ‡ä»¤ï¼‰

`mysqldump -uroot -proot db_2 t_40 t_42 > D:/t_40_42.sql`



#### è¿˜åŸ

1ã€åº“å±‚é¢

æŠŠ > æ¢æˆ  <  å³å¯

`mysql.exe -uroot -p db_2 < D:/t_40_42.sql`



2ã€è¡¨å±‚é¢

```mysql
source D:/t_40_42.sql;
```



## å…­ã€ç”¨æˆ·ç®¡ç†

### 1ã€è§’è‰²ç®¡ç†

**è§’è‰²**ç›¸å…³æ“ä½œå’Œè¯­æ³•

* åˆ›å»ºè§’è‰²ï¼š`create role è§’è‰²åå­—1[,è§’è‰²åå­—2,...è§’è‰²åå­—N]`ï¼ˆå¯æ‰¹é‡åˆ›å»ºï¼‰
* åˆ†é…æƒé™ï¼š`grant æƒé™åˆ—è¡¨ on æ•°æ®åº“|*.æ•°æ®è¡¨|* to è§’è‰²åå­—`
* ç»‘å®šè§’è‰²ï¼š`grant è§’è‰²åå­— to ç”¨æˆ·å@ä¸»æœºåœ°å€`
* æ’¤é”€è§’è‰²ï¼š`revoke è§’è‰²åå­— from ç”¨æˆ·å@ä¸»æœºåœ°å€`
* å›æ”¶è§’è‰²æƒé™ï¼š`revoke æƒé™åˆ—è¡¨ on æ•°æ®åº“|*.æ•°æ®è¡¨|* from è§’è‰²åå­—`
* åˆ é™¤è§’è‰²ï¼š`drop role è§’è‰²åå­—1[,è§’è‰²åå­—2,...è§’è‰²åå­—N]`

**å…³è”è§’è‰²**

1ã€åˆ›å»ºè§’è‰²

2ã€ç¡®å®šè§’è‰²çš„æƒé™ï¼šç»™è§’è‰²åˆ†é…æƒé™

3ã€å°†è§’è‰²åˆ†é…ç»™ç”¨æˆ·ï¼ˆå’Œç¬¬2æ­¥å¯ä»¥æ²¡æœ‰å…ˆåå…³ç³»ï¼‰

4ã€æƒé™åˆ†é…è€…æ¯æ¬¡ç™»é™†æœåŠ¡å™¨æ—¶âœ¨æ¿€æ´»è§’è‰²ï¼š

- `set default role all  to ç”¨æˆ·å@ä¸»æœºåœ°å€`ï¼ˆä¸€æ¬¡åªèƒ½æ¿€æ´»ä¸€ä¸ªè§’è‰²ï¼‰

* æ¿€æ´»ä¹‹åå¯¹åº”çš„ç”¨æˆ·éœ€è¦é€€å‡ºä¹‹åé‡æ–°ç™»å½•æ‰è¡Œ

åˆ›å»ºï¼š

```mysql
# åˆ›å»ºè§’è‰²ï¼ˆè§’è‰²ä¸ç”¨æˆ·åå¾ˆç›¸ä¼¼ï¼‰
create role developer,app_read,app_write;

# ç»™è§’è‰²åˆ†é…æƒé™
grant all on db_2.* to developer;
grant select on db_2.* to app_read;
grant insert,update,delete on db_2.* to app_write;

# åˆ›å»ºç”¨æˆ·ï¼Œå¹¶åˆ†é…è§’è‰²ç»™ç”¨æˆ·
create user 'admin1'@'%' identified by '1234';
create user 'admin2'@'%' identified by '1234';
create user 'admin3'@'%' identified by '1234';

grant developer to 'admin1'@'%';
grant app_read to 'admin2'@'%','admin1'@'%'; # å…è®¸æ‰¹é‡ç»™ç”¨æˆ·åˆ†é…è§’è‰²
grant app_write to 'admin3'@'%';
```

å›æ”¶ï¼š

```mysql
# å›æ”¶è§’è‰²æƒé™
revoke insert,delete on db_2.* from app_write;

# å›æ”¶è§’è‰²
revoke app_read from 'admin2'@'%';

# åˆ é™¤è§’è‰²
drop role developer;
```



### 2ã€æƒé™ç®¡ç†

å¸¸ç”¨çš„å¼€å‘è€…æƒé™æœ‰ï¼š

* createã€alterã€dropï¼šåº“ã€è¡¨ç»“æ„æ“ä½œ
* insertã€selectã€updateã€deleteï¼šæ•°æ®æ“ä½œ
* referencesï¼šå¤–é”®æƒé™
* indexï¼šç´¢å¼•

è´¦å·çš„ç®¡ç†é€šå¸¸éœ€è¦é…åˆæƒé™çš„ä½¿ç”¨

* èµ‹æƒï¼šç»™è´¦å·ç»‘å®šç›¸åº”çš„æƒé™ `grant æƒé™åˆ—è¡¨ on æ•°æ®åº“|*.æ•°æ®è¡¨|* to ç”¨æˆ·å@ä¸»æœºåœ°å€ `
* å›æ”¶ï¼šå°†è´¦å·å·²æœ‰çš„æƒé™å›æ”¶ `revoke æƒé™åˆ—è¡¨ on æ•°æ®åº“|*.æ•°æ®è¡¨|* from ç”¨æˆ·å@ä¸»æœºåœ°å€ `
* åˆ·æ–°æƒé™ï¼š`flush privileges`
* æŸ¥çœ‹æƒé™ï¼š`show grants for ç”¨æˆ·å@ä¸»æœºåœ°å€`



### 3ã€è´¦å·ç®¡ç†

### 1ã€è´¦å·ç®¡ç†

**è´¦å·ç®¡ç†**ï¼šæ ¹æ®é¡¹ç›®çš„éœ€æ±‚è®¾ç½®å’Œç®¡ç†è´¦å·

* è´¦å·æ˜¯æƒé™ä¾èµ–çš„å¯¹è±¡ï¼Œå…ˆæœ‰è´¦å·æ‰æœ‰æƒé™
* MySQLä¸­è´¦å·çš„ç»„æˆåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šç”¨æˆ·å @ ä¸»æœºåœ°å€ï¼ˆroot@localhostï¼‰
  * ç”¨æˆ·åä¸ºç”¨æˆ·ç™»å½•æ—¶çš„åå­—
  * ä¸»æœºåœ°å€ï¼šæ˜¯å…è®¸è´¦å·æ‰€åœ¨å®¢æˆ·ç«¯çš„è®¿é—®çš„å®¢æˆ·ç«¯IPï¼ˆå¦‚ä¸Šè¿°rootåªèƒ½åœ¨æœåŠ¡å™¨æœ¬æœºé€šè¿‡å®¢æˆ·ç«¯è®¿é—®ï¼‰
* è´¦å·ç®¡ç†
  * åˆ›å»ºè´¦å·ï¼š`create user ç”¨æˆ·å@ä¸»æœºåœ°å€ identified by 'æ˜æ–‡å¯†ç ';`
  * åˆ é™¤è´¦å·ï¼š`drop user ç”¨æˆ·å@ä¸»æœºåœ°å€`



1ã€æ ¹æ®é¡¹ç›®æƒ…å†µï¼Œè·Ÿä¸åŒçš„é¡¹ç›®ç»„åˆ›å»ºä¸åŒçš„è´¦å·

```mysql
# Aå›¢é˜Ÿåªå…è®¸åœ¨å…¬å¸è®¿é—®æœåŠ¡å™¨ï¼Œå…¬å¸IPä¸º163.177.151.110
create user `admin`@`163.177.151.110` identified by 'admin123';

# Bå›¢é˜Ÿä¸é™å®šè´Ÿè´£æ•°æ®åº“ç®¡ç†ï¼Œä¸é™å®šå·¥ä½œåœ°ç‚¹
create user `admin` identified by 'admin321';
```



2ã€å¼€å‘ä»»åŠ¡ç»“æŸï¼ŒAå›¢é˜Ÿçš„ä»»åŠ¡å·²ç»å®Œæˆï¼Œä¸éœ€è¦è¿›è¡Œæ•°æ®åº“æ“ä½œ

```mysql
drop user `admin`@`163.177.151.110`;
```